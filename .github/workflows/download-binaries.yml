name: Reusable - Download Binaries

on:
  workflow_call:
    inputs:
      project:
        description: '项目名称 (mihomo)'
        required: true
        type: string
      variant:
        description: '变体标识 (meta | alpha | smart)'
        required: true
        type: string
      version:
        description: '版本号'
        required: true
        type: string

jobs:
  download:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux平台（所有mihomo版本都支持）
          - { platform: linux, arch: amd64-v1 }
          - { platform: linux, arch: amd64-v3 }
          - { platform: linux, arch: armv5 }
          - { platform: linux, arch: armv6 }
          - { platform: linux, arch: armv7 }
          - { platform: linux, arch: arm64 }
          - { platform: linux, arch: mips-softfloat }
          - { platform: linux, arch: mipsle-softfloat }
          - { platform: linux, arch: mipsle-hardfloat }
          # Windows平台（所有mihomo版本都支持）
          - { platform: windows, arch: amd64-v1 }
          - { platform: windows, arch: amd64-v3 }
          - { platform: windows, arch: arm64 }
          # macOS平台（Meta和Alpha支持，Smart可能不支持）
          - { platform: darwin, arch: amd64 }
          - { platform: darwin, arch: arm64 }
          # Android平台（仅Meta和Alpha支持，Smart不支持）
          - { platform: android, arch: arm64 }
          - { platform: android, arch: armv7 }
          - { platform: android, arch: amd64 }
      fail-fast: false
    
    steps:
      - name: Checkout主仓库（获取处理脚本）
        uses: actions/checkout@v4

      - name: 下载并处理
        run: |
          mkdir -p ./artifacts ./tmp
          
          # 设置下载URL
          case "${{ inputs.variant }}" in
            meta)
              BASE_URL="https://github.com/MetaCubeX/mihomo/releases/download/${{ inputs.version }}"
              ;;
            alpha)
              BASE_URL="https://github.com/MetaCubeX/mihomo/releases/download/Prerelease-Alpha"
              ;;
            smart)
              BASE_URL="https://github.com/vernesong/mihomo/releases/download/${{ inputs.version }}"
              ;;
            *)
              echo "未知变体: ${{ inputs.variant }}"
              exit 1
              ;;
          esac
          
          # 构建文件名前缀
          FILE_PREFIX="mihomo-${{ matrix.platform }}-${{ matrix.arch }}"
          
          # 尝试下载，失败则记录但不终止
          set +e
          
          if [[ "${{ matrix.platform }}" == "linux" ]]; then
            URL="${BASE_URL}/${FILE_PREFIX}-${{ inputs.version }}.gz"
            echo "尝试下载: $URL"
            curl -fSL --max-time 300 "$URL" | gunzip -c > ./tmp/mihomo 2>/dev/null
            if [[ $? -eq 0 && -s ./tmp/mihomo ]]; then
              chmod +x ./tmp/mihomo
              SOURCE_FILE="./tmp/mihomo"
            else
              echo "警告: Linux ${{ matrix.arch }} 下载失败或文件为空，跳过"
              exit 0
            fi
            
          elif [[ "${{ matrix.platform }}" == "windows" ]]; then
            URL="${BASE_URL}/${FILE_PREFIX}-${{ inputs.version }}.zip"
            echo "尝试下载: $URL"
            curl -fSL --max-time 300 -o ./tmp/download.zip "$URL" 2>/dev/null
            if [[ $? -eq 0 && -s ./tmp/download.zip ]]; then
              unzip -q ./tmp/download.zip -d ./tmp/ 2>/dev/null
              SOURCE_FILE=$(find ./tmp -name "*.exe" | head -n1)
              if [[ -z "$SOURCE_FILE" ]]; then
                echo "警告: Windows ${{ matrix.arch }} 解压后找不到exe，跳过"
                exit 0
              fi
            else
              echo "警告: Windows ${{ matrix.arch }} 下载失败，跳过"
              exit 0
            fi
            
          elif [[ "${{ matrix.platform }}" == "darwin" ]]; then
            # macOS可能是gz或zip格式，先尝试gz
            URL="${BASE_URL}/${FILE_PREFIX}-${{ inputs.version }}.gz"
            echo "尝试下载: $URL"
            curl -fSL --max-time 300 "$URL" | gunzip -c > ./tmp/mihomo 2>/dev/null
            if [[ $? -eq 0 && -s ./tmp/mihomo ]]; then
              chmod +x ./tmp/mihomo
              SOURCE_FILE="./tmp/mihomo"
            else
              # 尝试zip格式
              URL="${BASE_URL}/${FILE_PREFIX}-${{ inputs.version }}.zip"
              echo "尝试下载zip: $URL"
              curl -fSL --max-time 300 -o ./tmp/download.zip "$URL" 2>/dev/null
              if [[ $? -eq 0 && -s ./tmp/download.zip ]]; then
                unzip -q ./tmp/download.zip -d ./tmp/ 2>/dev/null
                SOURCE_FILE=$(find ./tmp -type f ! -name "*.zip" | head -n1)
                if [[ -n "$SOURCE_FILE" ]]; then
                  chmod +x "$SOURCE_FILE" 2>/dev/null || true
                else
                  echo "警告: macOS ${{ matrix.arch }} 解压后找不到文件，跳过"
                  exit 0
                fi
              else
                echo "警告: macOS ${{ matrix.arch }} 下载失败，跳过"
                exit 0
              fi
            fi
            
          elif [[ "${{ matrix.platform }}" == "android" ]]; then
            URL="${BASE_URL}/${FILE_PREFIX}-${{ inputs.version }}.gz"
            echo "尝试下载: $URL"
            curl -fSL --max-time 300 "$URL" | gunzip -c > ./tmp/mihomo 2>/dev/null
            if [[ $? -eq 0 && -s ./tmp/mihomo ]]; then
              chmod +x ./tmp/mihomo
              SOURCE_FILE="./tmp/mihomo"
            else
              echo "警告: Android ${{ matrix.arch }} 下载失败，跳过"
              exit 0
            fi
          fi
          
          set -e
          
          # 验证源文件
          if [[ -z "$SOURCE_FILE" ]] || [[ ! -f "$SOURCE_FILE" ]]; then
            echo "错误: 源文件不存在"
            exit 0
          fi
          
          # 调用处理脚本
          bash .github/scripts/lib/artifact-handler.sh \
            "$SOURCE_FILE" \
            "${{ inputs.project }}" \
            "${{ inputs.variant }}" \
            "${{ matrix.platform }}" \
            "${{ matrix.arch }}" \
            "./artifacts"

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project }}-${{ inputs.variant }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: ./artifacts/*
          retention-days: 1
        if: ${{ hashFiles('./artifacts/*') != '' }}
